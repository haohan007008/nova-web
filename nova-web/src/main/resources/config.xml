<?xml version="1.0" encoding="UTF-8" ?>
<config>
	<variables>
		<variable name="dubbo_config_xml"><![CDATA[classpath*:/conf/applicationContext-dubbo.xml]]></variable>
		<variable name="data_page_size">50</variable>
	</variables>	
	<scripts>
		<script name="report_orders_day">
			<![CDATA[
				select dt,
					sum(CASE curNode WHEN 1 THEN cnt ELSE 0 END ) s1_cnt,
				  sum(CASE curNode WHEN 2 THEN cnt ELSE 0 END ) s2_cnt,
					sum(CASE curNode WHEN 3 THEN cnt ELSE 0 END ) s3_cnt,
					sum(CASE curNode WHEN 4 THEN cnt ELSE 0 END ) s4_cnt,
					sum(CASE curNode WHEN 5 THEN cnt ELSE 0 END ) s5_cnt,
					sum(CASE curNode WHEN 6 THEN cnt ELSE 0 END ) s6_cnt,
					sum(CASE curNode WHEN 7 THEN cnt ELSE 0 END ) s7_cnt,
					sum(CASE curNode WHEN 1 THEN totalPrd ELSE 0 END ) t1_cnt,
				  sum(CASE curNode WHEN 2 THEN totalPrd ELSE 0 END ) t2_cnt,
					sum(CASE curNode WHEN 3 THEN totalPrd ELSE 0 END ) t3_cnt,
					sum(CASE curNode WHEN 4 THEN totalPrd ELSE 0 END ) t4_cnt,
					sum(CASE curNode WHEN 5 THEN totalPrd ELSE 0 END ) t5_cnt,
					sum(CASE curNode WHEN 6 THEN totalPrd ELSE 0 END ) t6_cnt,
					sum(CASE curNode WHEN 7 THEN totalPrd ELSE 0 END ) t7_cnt,
					sum(CASE curNode WHEN 1 THEN totalPay ELSE 0 END ) p1_cnt,
				  sum(CASE curNode WHEN 2 THEN totalPay ELSE 0 END ) p2_cnt,
					sum(CASE curNode WHEN 3 THEN totalPay ELSE 0 END ) p3_cnt,
					sum(CASE curNode WHEN 4 THEN totalPay ELSE 0 END ) p4_cnt,
					sum(CASE curNode WHEN 5 THEN totalPay ELSE 0 END ) p5_cnt,
					sum(CASE curNode WHEN 6 THEN totalPay ELSE 0 END ) p6_cnt,
					sum(CASE curNode WHEN 7 THEN totalPay ELSE 0 END ) p7_cnt
				 from  vm_order_statics 
				 where 1=1 
				group by dt
				union ALL
				select '合计',
					sum(CASE curNode WHEN 1 THEN cnt ELSE 0 END ) s1_cnt,
				  sum(CASE curNode WHEN 2 THEN cnt ELSE 0 END ) s2_cnt,
					sum(CASE curNode WHEN 3 THEN cnt ELSE 0 END ) s3_cnt,
					sum(CASE curNode WHEN 4 THEN cnt ELSE 0 END ) s4_cnt,
					sum(CASE curNode WHEN 5 THEN cnt ELSE 0 END ) s5_cnt,
					sum(CASE curNode WHEN 6 THEN cnt ELSE 0 END ) s6_cnt,
					sum(CASE curNode WHEN 7 THEN cnt ELSE 0 END ) s7_cnt,
					sum(CASE curNode WHEN 1 THEN totalPrd ELSE 0 END ) t1_cnt,
				  sum(CASE curNode WHEN 2 THEN totalPrd ELSE 0 END ) t2_cnt,
					sum(CASE curNode WHEN 3 THEN totalPrd ELSE 0 END ) t3_cnt,
					sum(CASE curNode WHEN 4 THEN totalPrd ELSE 0 END ) t4_cnt,
					sum(CASE curNode WHEN 5 THEN totalPrd ELSE 0 END ) t5_cnt,
					sum(CASE curNode WHEN 6 THEN totalPrd ELSE 0 END ) t6_cnt,
					sum(CASE curNode WHEN 7 THEN totalPrd ELSE 0 END ) t7_cnt,
					sum(CASE curNode WHEN 1 THEN totalPay ELSE 0 END ) p1_cnt,
				  sum(CASE curNode WHEN 2 THEN totalPay ELSE 0 END ) p2_cnt,
					sum(CASE curNode WHEN 3 THEN totalPay ELSE 0 END ) p3_cnt,
					sum(CASE curNode WHEN 4 THEN totalPay ELSE 0 END ) p4_cnt,
					sum(CASE curNode WHEN 5 THEN totalPay ELSE 0 END ) p5_cnt,
					sum(CASE curNode WHEN 6 THEN totalPay ELSE 0 END ) p6_cnt,
					sum(CASE curNode WHEN 7 THEN totalPay ELSE 0 END ) p7_cnt
				 from  vm_order_statics 
			 ]]>
		</script>
		<script name="buzAduit">
			<![CDATA[
				update r_order o set o.curNode = ? ,o.curOperator = ? where id = ?
			 ]]>
		</script>
		<script name="finAduit">
			<![CDATA[
				update r_order o set o.curNode = ? ,o.curOperator = ? ,o.prePayTime = ?,o.payAccount=? where id = ?
			 ]]>
		</script>
		<script name="getorderlog">
			<![CDATA[
				select l.*,n.nodeName,f.name userName from r_order_log l,f_flownode n ,p_staff f
				where l.orderId = ? and l.action = n.id
				and f.id = l.userId
				order by timestamp asc

			 ]]>
		</script>
		<script name="addorderlog">
			<![CDATA[
				insert into r_order_log(orderId,userId,action,remark)values(?,?,?,?)
			 ]]>
		</script>
		<script name="getorderNo">
			<![CDATA[
				select  CONCAT(DATE_FORMAT(now(),'%Y%m%d'),lpad(count(1)+1,4,'0')) orderno
					 from r_order r where DATE_FORMAT(r.`timestamp`,'%Y%m%d') = date_format(now(),'%Y%m%d')
			 ]]>
		</script>
		<script name="canelOrder">
			<![CDATA[
				update r_order set curNode =7 ,oprState = 8,curOperator=0 where id = ?
			 ]]>
		</script>
		<script name="canelOrderItem">
			<![CDATA[
				update r_orderitem set oprState =8 where orderId = ?
			 ]]>
		</script>
		<script name="bakOrder">
			<![CDATA[
				insert into r_order_his select * from r_order where id = ?
			 ]]>
		</script>
		<script name="disableorderitem">
			<![CDATA[
			update r_orderitem o set o.oprState = 9 where o.orderId = ?
			]]>
		</script>
		<script name="aduitOrder">
			<![CDATA[
			update r_order  set 
										remark = ? ,
										totalPay = ?,
										prePay=?,
										totalPrd=?,
										curNode=?,
										curOperator=?
			where id = ?
			]]>
		</script>
		<script name="getOrderByID">
			<![CDATA[
				select o.*,fn.nodeName,f.name as creator ,f1.name as curOper
					from r_order o
				inner JOIN f_flownode fn on o.curNode = fn.id
				inner join p_staff f on f.Id = o.staffId
				left JOIN p_staff f1 on f1.Id = o.curOperator
				where  o.id = ?
			 ]]>
		</script>
		<script name="getOrderItemsByOrderId">
			<![CDATA[
				select * from r_orderitem where orderId = ? and oprState=0 order by prdId,prdColorId
			 ]]>
		</script>
		<script name="getOrders">
			<![CDATA[
				SELECT * from (select o.id,o.name orderNo,o.curNode,fn.nodeName,o.custName,o.totalPrd,o.totalPay,
						o.staffId,f.name as creator ,o.curOperator,f1.name as curOper,o.timestamp,o.oprState
						from r_order o 
	            INNER JOIN f_flownode fn on o.curNode = fn.id
				      INNER JOIN p_staff f on f.Id = o.staffId 
	            LEFT JOIN p_staff f1 on f1.Id = o.curOperator ORDER BY O.`timestamp` DESC ) a where 1=1 
			 ]]>
		</script>
		<script name="getOrdersCount">
			<![CDATA[
				SELECT count(*) from (select o.id,o.name orderNo,o.curNode,fn.nodeName,o.custName,o.totalPrd,o.totalPay,
						o.staffId,f.name as creator ,o.curOperator,f1.name as curOper,o.timestamp,o.oprState
						from r_order o 
	            INNER JOIN f_flownode fn on o.curNode = fn.id
				      INNER JOIN p_staff f on f.Id = o.staffId 
	            LEFT JOIN p_staff f1 on f1.Id = o.curOperator  ) a where 1=1 
			 ]]>
		</script>
		<script name="myOperOrdersCount">
			<![CDATA[
				SELECT count(1) from (select o.id,o.curNode,fn.nodeName,o.custName,o.totalPrd,o.totalPay,
					o.staffId,f.name as creator ,o.curOperator,f1.name as curOper,o.timestamp,o.oprState
					from r_order o,f_flownode fn,p_staff f,p_staff f1
				where  o.curNode = fn.id
				and f.Id = o.staffId and f1.Id = o.curOperator ) a where 1=1 and curOperator = ?
			 ]]>
		</script>
		
		<script name="myOrdersCount">
			<![CDATA[
				select count(1)
					from r_order o
				where o.staffId = ?
			 ]]>
		</script>
		
		<script name="addorder">
			<![CDATA[
				insert into r_order(Id,name,flowId,curNode,custName,staffId,totalPay,prePay,totalPrd,shipAddress,curOperator)
				VALUES(?,?,?,?,?,?,?,?,?,?,?)
			 ]]>
		</script>
		<script name="addorderitem">
			<![CDATA[
				insert into r_orderitem(orderId,prdId,prdColorId,prdColorNo,prdColorName,nxxl,nxl,nl,nm,ns,prdNum,price,subTotal)
				VALUES(?,?,?,?,?,?,?,?,?,?,?,?,?)
			 ]]>
		</script>
		<script name="lastId">
			<![CDATA[
				select max(id)+1 from r_order
			 ]]>
		</script>
		
		<script name="getNextOperator">
			<![CDATA[
				select rf.staffId from f_flownode fn,p_rolestaff rf 
				where rf.roleId = fn.roleId
				and fn.flowId = ? and fn.id = ?
			 ]]>
		</script>
		
		<script name="updateorderitems">
			<![CDATA[
			update r_orderitem o set o.prdNum = o.nxxl + o.nxl + o.nl + o.nm + o.ns ,
				o.price = (select if((o.nxxl + o.nxl + o.nl + o.nm + o.ns) >= 30,p.batchPrice,p.price) from c_product p where p.id = o.prdId),
				o.subtotal = (select (if((o.nxxl + o.nxl + o.nl + o.nm + o.ns) >= 30,p.batchPrice,p.price))*(nxxl + o.nxl + o.nl + o.nm + o.ns)
						from c_product p where p.id = o.prdId) 
			where o.orderId = ?
			]]>
		</script>
		<script name="updateorder">
			<![CDATA[
			update r_order o 
				set o.totalPay = (select sum(subTotal) from r_orderitem i where i.orderId = o.id),
					  o.prePay = (select sum(subTotal)*0.4 from r_orderitem i where i.orderId = o.id),
						o.lastPay = (select sum(subTotal)*0.6 from r_orderitem i where i.orderId = o.id),
						o.totalPrd = (select sum(prdNum) from r_orderitem i where i.orderId = o.id)
				where  id = ?
			]]>
		</script>
		
		<script name="gerOrderCreatorBYId">
			<![CDATA[
			select r.staffId from r_order r,p_rolestaff rf 
				where r.staffId = rf.staffId and r.id = ? and rf.roleId =2
			]]>
		</script>
		
		<script name="deleteorder">
			<![CDATA[
			delete r_order o where o.id = ?
			]]>
		</script>
		<script name="deleteorderitem">
			<![CDATA[
			delete r_orderitem o where o.orderId = ?
			]]>
		</script>
		<script name="loginfo">
			<![CDATA[
				select max(timestamp) timestamp,
						count(*) cnt,
						(select s.loginIp from s_syslog s where s.staffId = a.staffId ORDER BY timestamp DESC LIMIT 1 )loginIp
			 	from s_syslog a where a.staffId = ?
			 ]]>
		</script>
		<script name="logs">
			<![CDATA[
				insert into s_syslog(staffId,loginIp,action)values(?,?,?)
			 ]]>
		</script>
		<script name="userlogin">
			<![CDATA[
				select a.Id,a.name,a.deptId,a.telphone1,a.telphone2,a.loginName,d.deptName,max(l.timestamp) timestamp,sum(1) cnt,
					(select s.loginIp from s_syslog s where s.staffId = l.staffId  ORDER BY timestamp DESC LIMIT 1 ) loginIp
					 from p_staff a
					  INNER JOIN p_deptstaff df ON df.staffId = a.id
					  INNER JOIN p_dept d ON d.id = df.deptId 
						left join s_syslog l on a.id = l.staffId
					WHERE  a.loginName = ? and a.loginPwd =? AND a.isVaild = 0
					GROUP BY a.Id,a.name,a.deptId,a.telphone1,a.telphone2,a.loginName,d.deptName
			 ]]>
		</script>
		<script name="getperms">
			<![CDATA[
				select p.Id,p.permName,p.permUrl,p.remark,p.pId,p.orderIndex,p.icon,p.permType
				from p_rolestaff rf,p_roleperm rp ,
					p_permission p
				where rf.staffId = ?
				and rf.roleId = rp.roleId
				and rp.isVaild = 0
				and rp.permId = p.id
				order by p.orderIndex 
			 ]]>
		</script>
		<script name="getroles">
			<![CDATA[
				select r.* from p_roles r,p_rolestaff rf where r.Id = rf.roleId and rf.staffId=?
			 ]]>
		</script>
		<script name="getproducts">
			<![CDATA[
				select p.*,d.dictval catalog_name from c_product p,p_dict d 
				where p.prdName like ?
				and d.dictName = 'catalog'
				and p.catalog = d.dictKey
				limit ?,?
			 ]]>
		</script>
		
		<script name="autoproduct">
			<![CDATA[
				select  CONCAT('[',d.dictval,']',p.prdNo,'-',p.prdName) from c_product p,p_dict d 
				where p.prdName like ?
				and d.dictName = 'catalog'
				and p.catalog = d.dictKey
				limit 0,20
			 ]]>
		</script>
		
		<script name="getproductsCount">
			<![CDATA[
				select count(1) from c_product p
				where p.prdName like ?
			 ]]>
		</script>
		
		<script name="getproductById">
			<![CDATA[
				select p.*,d.dictval catalog_name from c_product p,p_dict d 
				where p.Id = ?
				and d.dictName = 'catalog'
				and p.catalog = d.dictKey
			 ]]>
		</script>
		
		<script name="getProductColorById">
			<![CDATA[
				select * from c_product_color pc where pc.prdID = ?
			 ]]>
		</script>
	</scripts>
</config>